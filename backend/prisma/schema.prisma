// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Genero {
  masculino
  femenino
  otro
}

enum EstadoCita {
  pendiente
  confirmada
  en_proceso
  completada
  cancelada
  no_asistio
}

enum TipoMovimiento {
  entrada
  salida
  ajuste
}

enum TipoVenta {
  servicio
  producto
  mixta
}

enum MetodoPago {
  efectivo
  tarjeta
  transferencia
  mixto
}

enum EstadoVenta {
  pendiente
  pagada
  cancelada
}

enum TipoItem {
  servicio
  producto
}

enum DiaSemana {
  lunes
  martes
  miercoles
  jueves
  viernes
  sabado
  domingo
}

// ============================================
// MODELOS
// ============================================

model Rol {
  id             Int       @id @default(autoincrement())
  nombre         String    @unique @db.VarChar(50)
  descripcion    String?
  creadoEn       DateTime  @default(now()) @map("creado_en")
  actualizadoEn  DateTime  @updatedAt @map("actualizado_en")

  usuarios       Usuario[]

  @@map("roles")
}

model Usuario {
  id                  Int       @id @default(autoincrement())
  email               String    @unique @db.VarChar(100)
  passwordHash        String    @map("password_hash") @db.VarChar(255)
  rolId               Int       @map("rol_id")
  activo              Boolean   @default(true)
  ultimoAcceso        DateTime? @map("ultimo_acceso")
  creadoEn            DateTime  @default(now()) @map("creado_en")
  actualizadoEn       DateTime  @updatedAt @map("actualizado_en")

  rol                 Rol       @relation(fields: [rolId], references: [id])
  empleado            Empleado?
  cliente             Cliente?
  movimientosInventario MovimientoInventario[]

  @@map("usuarios")
}

model Cliente {
  id                Int       @id @default(autoincrement())
  usuarioId         Int?      @unique @map("usuario_id")
  nombre            String    @db.VarChar(100)
  apellido          String    @db.VarChar(100)
  telefono          String?   @db.VarChar(20)
  email             String?   @db.VarChar(100)
  fechaNacimiento   DateTime? @map("fecha_nacimiento") @db.Date
  genero            Genero    @default(otro)
  direccion         String?
  notas             String?
  fotoPerfil        String?   @map("foto_perfil") @db.VarChar(255)
  creadoEn          DateTime  @default(now()) @map("creado_en")
  actualizadoEn     DateTime  @updatedAt @map("actualizado_en")

  usuario           Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  citas             Cita[]
  ventas            Venta[]

  @@index([telefono])
  @@index([email])
  @@map("clientes")
}

model Empleado {
  id                    Int       @id @default(autoincrement())
  usuarioId             Int       @unique @map("usuario_id")
  nombre                String    @db.VarChar(100)
  apellido              String    @db.VarChar(100)
  telefono              String?   @db.VarChar(20)
  email                 String?   @db.VarChar(100)
  fechaContratacion     DateTime  @map("fecha_contratacion") @db.Date
  fechaNacimiento       DateTime? @map("fecha_nacimiento") @db.Date
  especialidad          String?   @db.VarChar(100)
  comisionPorcentaje    Decimal   @default(0.00) @map("comision_porcentaje") @db.Decimal(5, 2)
  salarioBase           Decimal?  @map("salario_base") @db.Decimal(10, 2)
  fotoPerfil            String?   @map("foto_perfil") @db.VarChar(255)
  activo                Boolean   @default(true)
  creadoEn              DateTime  @default(now()) @map("creado_en")
  actualizadoEn         DateTime  @updatedAt @map("actualizado_en")

  usuario               Usuario   @relation(fields: [usuarioId], references: [id])
  citas                 Cita[]
  ventas                Venta[]
  servicios             EmpleadoServicio[]
  horarios              HorarioEmpleado[]
  diasNoLaborables      DiaNoLaborable[]

  @@index([activo])
  @@map("empleados")
}

model CategoriaServicio {
  id              Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(100)
  descripcion     String?
  icono           String?   @db.VarChar(50)
  creadoEn        DateTime  @default(now()) @map("creado_en")
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")

  servicios       Servicio[]

  @@map("categorias_servicios")
}

model Servicio {
  id                Int       @id @default(autoincrement())
  categoriaId       Int       @map("categoria_id")
  nombre            String    @db.VarChar(100)
  descripcion       String?
  duracionMinutos   Int       @map("duracion_minutos")
  precio            Decimal   @db.Decimal(10, 2)
  activo            Boolean   @default(true)
  foto              String?   @db.VarChar(255)
  creadoEn          DateTime  @default(now()) @map("creado_en")
  actualizadoEn     DateTime  @updatedAt @map("actualizado_en")

  categoria         CategoriaServicio @relation(fields: [categoriaId], references: [id])
  empleados         EmpleadoServicio[]
  citasServicios    CitaServicio[]
  ventasDetalles    VentaDetalle[]

  @@map("servicios")
}

model EmpleadoServicio {
  id          Int       @id @default(autoincrement())
  empleadoId  Int       @map("empleado_id")
  servicioId  Int       @map("servicio_id")
  creadoEn    DateTime  @default(now()) @map("creado_en")

  empleado    Empleado  @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  servicio    Servicio  @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@unique([empleadoId, servicioId], name: "unique_empleado_servicio")
  @@map("empleados_servicios")
}

model Cita {
  id                    Int          @id @default(autoincrement())
  clienteId             Int          @map("cliente_id")
  empleadoId            Int          @map("empleado_id")
  fecha                 DateTime     @db.Date
  horaInicio            DateTime     @map("hora_inicio") @db.Time
  horaFin               DateTime     @map("hora_fin") @db.Time
  estado                EstadoCita   @default(pendiente)
  notas                 String?
  recordatorioEnviado   Boolean      @default(false) @map("recordatorio_enviado")
  creadoEn              DateTime     @default(now()) @map("creado_en")
  actualizadoEn         DateTime     @updatedAt @map("actualizado_en")

  cliente               Cliente      @relation(fields: [clienteId], references: [id])
  empleado              Empleado     @relation(fields: [empleadoId], references: [id])
  servicios             CitaServicio[]
  venta                 Venta?

  @@index([fecha])
  @@index([estado])
  @@index([clienteId])
  @@index([empleadoId])
  @@map("citas")
}

model CitaServicio {
  id                Int       @id @default(autoincrement())
  citaId            Int       @map("cita_id")
  servicioId        Int       @map("servicio_id")
  precio            Decimal   @db.Decimal(10, 2)
  duracionMinutos   Int       @map("duracion_minutos")
  creadoEn          DateTime  @default(now()) @map("creado_en")

  cita              Cita      @relation(fields: [citaId], references: [id], onDelete: Cascade)
  servicio          Servicio  @relation(fields: [servicioId], references: [id])

  @@map("citas_servicios")
}

model CategoriaProducto {
  id              Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(100)
  descripcion     String?
  creadoEn        DateTime  @default(now()) @map("creado_en")
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")

  productos       Producto[]

  @@map("categorias_productos")
}

model Producto {
  id                    Int       @id @default(autoincrement())
  categoriaId           Int       @map("categoria_id")
  codigoBarras          String?   @map("codigo_barras") @db.VarChar(50)
  nombre                String    @db.VarChar(100)
  descripcion           String?
  marca                 String?   @db.VarChar(100)
  precioCompra          Decimal?  @map("precio_compra") @db.Decimal(10, 2)
  precioVenta           Decimal   @map("precio_venta") @db.Decimal(10, 2)
  stockActual           Int       @default(0) @map("stock_actual")
  stockMinimo           Int       @default(0) @map("stock_minimo")
  activo                Boolean   @default(true)
  foto                  String?   @db.VarChar(255)
  creadoEn              DateTime  @default(now()) @map("creado_en")
  actualizadoEn         DateTime  @updatedAt @map("actualizado_en")

  categoria             CategoriaProducto @relation(fields: [categoriaId], references: [id])
  movimientosInventario MovimientoInventario[]
  ventasDetalles        VentaDetalle[]

  @@index([codigoBarras])
  @@index([activo])
  @@map("productos")
}

model MovimientoInventario {
  id                Int             @id @default(autoincrement())
  productoId        Int             @map("producto_id")
  tipoMovimiento    TipoMovimiento  @map("tipo_movimiento")
  cantidad          Int
  motivo            String?         @db.VarChar(255)
  usuarioId         Int?            @map("usuario_id")
  fechaMovimiento   DateTime        @default(now()) @map("fecha_movimiento")

  producto          Producto        @relation(fields: [productoId], references: [id])
  usuario           Usuario?        @relation(fields: [usuarioId], references: [id])

  @@map("movimientos_inventario")
}

model Venta {
  id            Int          @id @default(autoincrement())
  clienteId     Int?         @map("cliente_id")
  empleadoId    Int          @map("empleado_id")
  citaId        Int?         @unique @map("cita_id")
  tipoVenta     TipoVenta    @map("tipo_venta")
  subtotal      Decimal      @db.Decimal(10, 2)
  descuento     Decimal      @default(0.00) @db.Decimal(10, 2)
  impuesto      Decimal      @default(0.00) @db.Decimal(10, 2)
  total         Decimal      @db.Decimal(10, 2)
  metodoPago    MetodoPago   @map("metodo_pago")
  estado        EstadoVenta  @default(pendiente)
  notas         String?
  fechaVenta    DateTime     @default(now()) @map("fecha_venta")

  cliente       Cliente?     @relation(fields: [clienteId], references: [id])
  empleado      Empleado     @relation(fields: [empleadoId], references: [id])
  cita          Cita?        @relation(fields: [citaId], references: [id], onDelete: SetNull)
  detalles      VentaDetalle[]

  @@index([fechaVenta])
  @@index([estado])
  @@map("ventas")
}

model VentaDetalle {
  id                Int       @id @default(autoincrement())
  ventaId           Int       @map("venta_id")
  tipoItem          TipoItem  @map("tipo_item")
  servicioId        Int?      @map("servicio_id")
  productoId        Int?      @map("producto_id")
  cantidad          Int       @default(1)
  precioUnitario    Decimal   @map("precio_unitario") @db.Decimal(10, 2)
  subtotal          Decimal   @db.Decimal(10, 2)
  creadoEn          DateTime  @default(now()) @map("creado_en")

  venta             Venta     @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  servicio          Servicio? @relation(fields: [servicioId], references: [id])
  producto          Producto? @relation(fields: [productoId], references: [id])

  @@map("ventas_detalles")
}

model HorarioEmpleado {
  id              Int       @id @default(autoincrement())
  empleadoId      Int       @map("empleado_id")
  diaSemana       DiaSemana @map("dia_semana")
  horaInicio      DateTime  @map("hora_inicio") @db.Time
  horaFin         DateTime  @map("hora_fin") @db.Time
  activo          Boolean   @default(true)
  creadoEn        DateTime  @default(now()) @map("creado_en")
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")

  empleado        Empleado  @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@map("horarios_empleados")
}

model DiaNoLaborable {
  id            Int       @id @default(autoincrement())
  empleadoId    Int?      @map("empleado_id")
  fecha         DateTime  @db.Date
  motivo        String?   @db.VarChar(255)
  todoElDia     Boolean   @default(true) @map("todo_el_dia")
  horaInicio    DateTime? @map("hora_inicio") @db.Time
  horaFin       DateTime? @map("hora_fin") @db.Time
  creadoEn      DateTime  @default(now()) @map("creado_en")

  empleado      Empleado? @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@map("dias_no_laborables")
}

model Configuracion {
  id              Int       @id @default(autoincrement())
  clave           String    @unique @db.VarChar(100)
  valor           String
  descripcion     String?
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")

  @@map("configuracion")
}
